{
        http_port 8090
        https_port 443
        order authenticate before respond
        order authorize before basicauth
        security {
                local identity store localdb {
                    realm local
                    path /etc/caddy/users.json
                }

                authentication portal myportal {
                        crypto default token lifetime 3600
			            enable identity store localdb

                        cookie domain almachine.tail0984c.ts.net
                }

                authorization policy users_policy {
                        set auth url https://almachine.tail0984c.ts.net/auth

                        acl rule {
                                comment allow users
                                match role authp/admin
                                allow stop log info
                        }
                        acl rule {
                                comment default deny
                                match role any
                                deny log warn
                        }
                }

                authorization policy starrs_policy {
                        with basic auth portal myportal realm local
                        set auth url https://almachine.tail0984c.ts.net/auth

                        acl rule {
                                comment allow api
                                match role authp/api
                                allow stop log info
                        }
                        acl rule {
                                comment allow admin
                                match role authp/admin
                                allow stop log info
                        }
                        acl rule {
                                comment default deny
                                match role any
                                deny log warn
                        }
                }
        }
}

https://almachine.tail0984c.ts.net {
    route /radarr/* {
        authorize with starrs_policy
        reverse_proxy http://localhost:7878
    }

    route /sonarr/* {
        authorize with starrs_policy
        reverse_proxy http://localhost:8989
    }

    route /prowlarr/* {
        authorize with users_policy
        reverse_proxy http://localhost:9696
    }

    handle_path /qbt/* {
        authorize with users_policy
        reverse_proxy http://100.99.204.88:8080
    }

    route /auth* {
        authenticate with myportal
    }

    route /* {
        authorize with users_policy

        reverse_proxy http://localhost:3000
    }
}