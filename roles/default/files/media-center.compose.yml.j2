version: '2.3'
volumes:
  portainer_data:
services:
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: host
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
      - VERSION=docker
    volumes:
      - '{{ data.library.tvshows.path }}:/tv'
      - '{{ data.library.movies.path }}:/movies'
      - '{{ data.library.config.path }}:/config'
# {% if enable_quicksync %}
    devices:
      - /dev/dri:/dev/dri
# {% endif %}

  protonwire:
    image: ghcr.io/tprasadtp/protonwire:latest
    container_name: protonwire
    init: true
    restart: unless-stopped
    environment:
      WIREGUARD_PRIVATE_KEY: '{{ wireguard.secret }}'
      PROTONVPN_SERVER: '{{ wireguard.server }}'
    cap_add:
      - NET_ADMIN
    ports:
{% for key, port in wireguard.ports.items() %}
      - {{ port }}:{{ port }}
{% endfor %}
    sysctls:
      net.ipv4.conf.all.rp_filter: 2
      net.ipv6.conf.all.disable_ipv6: 1
    volumes:
      - type: tmpfs
        target: /tmp

  test_proxy:
    image: caddy:latest
    network_mode: service:protonwire
    command: |
      caddy reverse-proxy \
          --change-host-header \
          --from :{{ wireguard.ports.caddy }} \
          --to https://ip.me:443
